<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mobile 4-Point Mosaic</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:black;
  overflow:hidden;
}
canvas{
  width:100vw;
  height:auto;
  touch-action:none;
}
</style>
</head>

<body>

<canvas id="c"></canvas>

<script>

let canvas = document.getElementById("c");
let ctx = canvas.getContext("2d");

let img = new Image();
img.src = "test.jpg"; // 변경

let points = [];
let mosaicRate = 12;

function fitCanvas(){
  let ratio = img.width / img.height;
  canvas.width = window.innerWidth;
  canvas.height = window.innerWidth / ratio;
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
}
  
img.onload = ()=>{ fitCanvas(); }

window.addEventListener("orientationchange",()=>{
  setTimeout(fitCanvas,300);
});

function getXY(e){

  let rect = canvas.getBoundingClientRect();
  
  let x,y;

  if(e.touches){
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  }

  x = x * (canvas.width / rect.width);
  y = y * (canvas.height / rect.height);

  return {x,y};
}

function addPoint(x,y){

  points.push({x,y});

  if(points.length === 4){
    processMosaic();
    points=[];
  }
}

function processMosaic(){

  let minX = Math.min(...points.map(p=>p.x));
  let minY = Math.min(...points.map(p=>p.y));
  let maxX = Math.max(...points.map(p=>p.x));
  let maxY = Math.max(...points.map(p=>p.y));

  let w = maxX-minX;
  let h = maxY-minY;

  if(w<5 || h<5) return;

  let imgData = ctx.getImageData(minX,minY,w,h);

  let temp = document.createElement("canvas");
  temp.width = w;
  temp.height = h;

  let tctx = temp.getContext("2d");
  tctx.putImageData(imgData,0,0);

  tctx.drawImage(temp,0,0,w/mosaicRate,h/mosaicRate);
  tctx.drawImage(temp,0,0,w/mosaicRate,h/mosaicRate,0,0,w,h);

  ctx.drawImage(temp,minX,minY);

}

canvas.addEventListener("click",e=>{
  let p=getXY(e);
  addPoint(p.x,p.y);
});

canvas.addEventListener("touchstart",e=>{
  e.preventDefault();
  let p=getXY(e);
  addPoint(p.x,p.y);
});

</script>
</body>
</html>
