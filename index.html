<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Android Mosaic</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  height:100%;
  overflow:hidden;
  touch-action:none;
}
#c{
  display:block;
  width:100vw;
  height:100vh;
  touch-action:none;
}
</style>
</head>

<body>

<canvas id="c"></canvas>

<script>

let canvas = document.getElementById("c");
let ctx = canvas.getContext("2d",{willReadFrequently:true});

let img = new Image();
img.src = "test.jpg";   // ← 여기에 본인 파일명 입력

let points=[];
let mosaicRate = 12;
let imgRatio = 0;

function resizeCanvas(){

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  if(imgRatio===0) return;

  let drawH = canvas.width / imgRatio;

  if(drawH > canvas.height){
      drawH = canvas.height;
      canvas.width = drawH * imgRatio;
  }

  canvas.height = drawH;
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
}

img.onload = ()=>{
  imgRatio = img.width / img.height;
  resizeCanvas();
}

window.addEventListener("resize",()=>{
  resizeCanvas();
});

window.addEventListener("orientationchange",()=>{
  setTimeout(resizeCanvas,600);
});

function getXYTouch(e){

  let rect = canvas.getBoundingClientRect();

  let x = e.touches[0].clientX - rect.left;
  let y = e.touches[0].clientY - rect.top;

  x = x * (canvas.width / rect.width);
  y = y * (canvas.height / rect.height);

  return {x,y};
}

function addPointXY(x,y){

  points.push({x,y});

  if(points.length===4){
      applyMosaic();
      points=[];
  }
}

function applyMosaic(){

  let minX = Math.min(...points.map(p=>p.x));
  let minY = Math.min(...points.map(p=>p.y));
  let maxX = Math.max(...points.map(p=>p.x));
  let maxY = Math.max(...points.map(p=>p.y));

  let w = maxX - minX;
  let h = maxY - minY;

  if(w<5 || h<5) return;

  let sub = ctx.getImageData(minX,minY,w,h);

  let tmp = document.createElement("canvas");
  tmp.width = w;
  tmp.height = h;

  let tctx = tmp.getContext("2d");
  tctx.putImageData(sub,0,0);

  tctx.drawImage(tmp,0,0,w/mosaicRate,h/mosaicRate);
  tctx.drawImage(tmp,0,0,w/mosaicRate,h/mosaicRate,0,0,w,h);

  ctx.drawImage(tmp,minX,minY);
}

canvas.addEventListener("touchstart",e=>{
  e.preventDefault();
  let p=getXYTouch(e);
  addPointXY(p.x,p.y);
},{passive:false});

</script>
</body>
</html>
