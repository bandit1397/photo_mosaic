<!DOCTYPE html>
<html lang="ko">

<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Mobile Mosaic – FULL System</title>

<style>
body{
  font-family:sans-serif;
  margin:0;
  padding:0;
  background:#eee;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}

.wrapper{
  background:white;
  padding:20px;
  margin-top:25px;
  border-radius:12px;
  width:95%;
  max-width:950px;
  text-align:center;
  box-shadow:0 0 8px rgba(0,0,0,0.15);
}

#canvas{
  width:100%;
  height:auto;
  border:1px solid #aaa;
  touch-action:none;
}

button{
  padding:10px 15px;
  margin:5px;
  font-size:14px;
}

@media(max-width:500px){
button{ width:46%; }
}
</style>
</head>

<body>

<div class="wrapper">

<h2>비식별화(모자이크)</h2>

<input type="file" id="upload" accept="image/*">

<div style="margin:10px 0;">
  모자이크 강도 :
  <input id="rate" type="range" min="1" max="40" value="15"/>
  <span id="rateValue">15</span>
</div>

<button onclick="saveImage()">저장</button>
<button onclick="undo()">Undo</button>
<button onclick="redo()">Redo</button>
<button onclick="resetImage()">처음으로</button>

<br><br>
<canvas id="canvas"></canvas>

</div>

<script>

let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let img  = new Image();

let undoStack = [];
let redoStack = [];

let touches = [];
let blocks  = [];

let rate = 15;

let originalImage = null;

const rateSlider  = document.getElementById("rate");
const rateValue   = document.getElementById("rateValue");


// ======================================================
// 업로드
// ======================================================
document.getElementById("upload").addEventListener("change", e=>{

  img.src = URL.createObjectURL(e.target.files[0]);

  img.onload = ()=>{

    const MAX = 1500;
    let w = img.width;
    let h = img.height;

    if(w>MAX){ h = h*(MAX/w); w = MAX;}
    if(h>MAX){ w = w*(MAX/h); h = MAX;}

    canvas.width = w;
    canvas.height = h;

    ctx.drawImage(img,0,0,w,h);

    originalImage = canvas.toDataURL(); // 진짜 원본 저장

    blocks = [];
    clearHistory();
    pushUndo();
  };
});


// ======================================================
// 강도 변경 → 기존 모자이크 재계산
// ======================================================
rateSlider.oninput = ()=>{

  rate = Number(rateSlider.value);
  rateValue.innerText = rate;

  redrawBlocksOnly();  // ★ 핵심 기능
};



// ======================================================
// 4점 등록
// ======================================================
canvas.addEventListener("click", e=>{

  const r = canvas.getBoundingClientRect();
  let x=(e.clientX-r.left)*(canvas.width/r.width);
  let y=(e.clientY-r.top)*(canvas.height/r.height);

  register(x,y);
});

canvas.addEventListener("touchstart", e=>{
  const r = canvas.getBoundingClientRect();
  let t = e.touches[0];

  let x=(t.clientX-r.left)*(canvas.width/r.width);
  let y=(t.clientY-r.top)*(canvas.height/r.height);

  register(x,y);

  e.preventDefault();
},{passive:false});



// ======================================================
function register(x,y){

  touches.push({x,y});

  if(touches.length===4){
    createBlock();
    touches=[];
  }
}



// ======================================================
function createBlock(){

  let xs = touches.map(a=>a.x);
  let ys = touches.map(a=>a.y);

  let left   = Math.min(...xs);
  let right  = Math.max(...xs);
  let top    = Math.min(...ys);
  let bottom = Math.max(...ys);

  let w = right-left;
  let h = bottom-top;

  if(w<5 || h<5) return;

  blocks.push({left,top,w,h});

  redrawBlocksOnly();
  pushUndo();
}



// ======================================================
// 원본 적용 후 모자이크 전체 다시 그리기
// ======================================================
function redrawBlocksOnly(){

  // 원본 복구
  let im = new Image();
  im.src = originalImage;
  im.onload = ()=>{

    ctx.drawImage(im,0,0);

    blocks.forEach(b=>{
      mosaic(b.left,b.top,b.w,b.h);
    });

  }
}



// ======================================================
function mosaic(left,top,w,h){

  let cell = rate;

  let temp = document.createElement("canvas");
  temp.width = w;
  temp.height = h;
  let tctx = temp.getContext("2d");

  tctx.drawImage(canvas,left,top,w,h,0,0,w,h);

  for(let i=0;i<w;i+=cell){
    for(let j=0;j<h;j+=cell){

      let px = tctx.getImageData(i,j,1,1).data;

      tctx.fillStyle = `rgb(${px[0]},${px[1]},${px[2]})`;
      tctx.fillRect(i,j,cell,cell);
    }
  }

  ctx.drawImage(temp,left,top);
}



// ======================================================
// Undo / Redo
// ======================================================
function pushUndo(){
  undoStack.push(canvas.toDataURL());
  redoStack=[];
}

function undo(){
  if(undoStack.length<=1) return;

  redoStack.push(undoStack.pop());
  loadImage(undoStack.at(-1));
}

function redo(){
  if(redoStack.length===0) return;

  let x = redoStack.pop();
  undoStack.push(x);
  loadImage(x);
}

function loadImage(src){
  let im = new Image();
  im.src = src;
  im.onload = ()=>{ ctx.drawImage(im,0,0); };
}

function clearHistory(){ undoStack=[]; redoStack=[]; }



// ======================================================
// Reset
// ======================================================
function resetImage(){

  if(!originalImage) return;

  blocks = [];

  loadImage(originalImage);

  clearHistory();
  pushUndo();
}



// ======================================================
function saveImage(){

  let a = document.createElement("a");
  a.href = canvas.toDataURL();
  a.download = "mosaic.png";
  a.click();
}



// ======================================================
document.addEventListener("keydown", e=>{
  if(e.ctrlKey && e.key==="z") undo();
  if(e.ctrlKey && e.key==="y") redo();
});

</script>

</body>
</html>
