<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mosaic Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  height:100%;
  overflow:hidden;
}
#c{
  display:block;
  width:100vw;
  height:100vh;
  touch-action:none;
}
#fileBox{
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:100;
}
</style>
</head>

<body>

<div id="fileBox">
  <input type="file" id="file" accept="image/*">
</div>

<canvas id="c"></canvas>

<script>

let canvas = document.getElementById("c");
let ctx = canvas.getContext("2d",{willReadFrequently:true});

let img = new Image();
let imgLoaded = false;
let points = [];
let mosaicRate = 12;

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  if(imgLoaded){
    drawScaledImage();
  }
}

function drawScaledImage(){

  let ratio = img.width / img.height;
  let cw = canvas.width;
  let ch = canvas.height;

  let drawH = cw / ratio;

  if(drawH > ch){
     drawH = ch;
     cw = drawH * ratio;
  }

  canvas.width = cw;
  canvas.height = drawH;

  ctx.drawImage(img,0,0,cw,drawH);
}


//============== 이미지 로드 ==================

document.getElementById("file").addEventListener("change", e=>{

  let file = e.target.files[0];
  let url = URL.createObjectURL(file);

  img.src = url;

  img.onload = ()=>{
     imgLoaded = true;
     resizeCanvas();
  };

});


//============== 터치 좌표 ==================

canvas.addEventListener("touchstart",e=>{
  if(!imgLoaded) return;

  let rect = canvas.getBoundingClientRect();

  let x = (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
  let y = (e.touches[0].clientY - rect.top) * (canvas.height / rect.height);

  points.push({x,y});

  if(points.length === 4){
     mosaicBy4();
     points = [];
  }

},{passive:false});


//============== 모자이크 처리 ==================

function mosaicBy4(){

  let minX = Math.min(...points.map(p=>p.x));
  let minY = Math.min(...points.map(p=>p.y));
  let maxX = Math.max(...points.map(p=>p.x));
  let maxY = Math.max(...points.map(p=>p.y));

  let w = maxX - minX;
  let h = maxY - minY;

  if(w<5 || h<5) return;

  let sub = ctx.getImageData(minX,minY,w,h);

  let tmp = document.createElement("canvas");
  tmp.width = w;
  tmp.height = h;

  let tctx = tmp.getContext("2d");
  tctx.putImageData(sub,0,0);

  tctx.drawImage(tmp,0,0,w/mosaicRate,h/mosaicRate);
  tctx.drawImage(tmp,0,0,w/mosaicRate,h/mosaicRate,0,0,w,h);

  ctx.drawImage(tmp,minX,minY);

}


window.addEventListener("resize",()=>resizeCanvas());
window.addEventListener("orientationchange",()=>setTimeout(resizeCanvas,600));

</script>
</body>
</html>
